{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { createClient } from \"@supabase/supabase-js\"\nimport { cookies } from \"next/headers\"\n\nexport async function getSupabaseServerClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Server Component - ignore\n        }\n      },\n    },\n  })\n}\n\nexport async function getSupabaseAdminClient() {\n  // Use createClient with service role key to bypass RLS\n  // Do NOT use createServerClient with service role key - it still respects RLS\n  return createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,4BAA4B;gBAC9B;YACF;QACF;IACF;AACF;AAEO,eAAe;IACpB,uDAAuD;IACvD,8EAA8E;IAC9E,OAAO,IAAA,yLAAY,gFAAwC,QAAQ,GAAG,CAAC,yBAAyB,EAAG;QACjG,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/utils/booking.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nconst QR_SECRET = process.env.QR_SIGNING_SECRET || \"default-secret-change-in-production\"\n\nexport function generateBookingReference(): string {\n  const date = new Date()\n  const dateStr = date.toISOString().slice(0, 10).replace(/-/g, \"\")\n  const randomPart = crypto.randomBytes(2).toString(\"hex\").toUpperCase()\n  return `THTR-${dateStr}-${randomPart}`\n}\n\nexport function generateQRSignature(data: object): string {\n  const payload = JSON.stringify(data)\n  return crypto.createHmac(\"sha256\", QR_SECRET).update(payload).digest(\"hex\")\n}\n\nexport function verifyQRSignature(data: object, signature: string): boolean {\n  const expectedSignature = generateQRSignature(data)\n  return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSignature))\n}\n\nexport function createQRCodeData(\n  bookingId: string,\n  reference: string,\n  showId: string,\n  showTitle: string,\n  showDatetime: string,\n  customerName: string,\n  seats: Array<{ section: string; row: string; number: number }>,\n) {\n  const dataWithoutSignature = {\n    booking_id: bookingId,\n    reference,\n    show_id: showId,\n    show_title: showTitle,\n    show_datetime: showDatetime,\n    customer_name: customerName,\n    seats,\n    checked_in: false,\n  }\n\n  const signature = generateQRSignature(dataWithoutSignature)\n\n  return {\n    ...dataWithoutSignature,\n    signature,\n  }\n}\n\nexport function formatPrice(amount: number): string {\n  return new Intl.NumberFormat(\"nb-NO\", {\n    style: \"currency\",\n    currency: \"NOK\",\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0,\n  }).format(amount)\n}\n\nexport function formatDate(dateString: string): string {\n  return new Intl.DateTimeFormat(\"nb-NO\", {\n    weekday: \"long\",\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  }).format(new Date(dateString))\n}\n\nexport function formatTime(dateString: string): string {\n  return new Intl.DateTimeFormat(\"nb-NO\", {\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  }).format(new Date(dateString))\n}\n\nexport function formatDateTime(dateString: string): string {\n  return `${formatDate(dateString)} kl. ${formatTime(dateString)}`\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;AAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,iBAAiB,IAAI;AAE5C,SAAS;IACd,MAAM,OAAO,IAAI;IACjB,MAAM,UAAU,KAAK,WAAW,GAAG,KAAK,CAAC,GAAG,IAAI,OAAO,CAAC,MAAM;IAC9D,MAAM,aAAa,gHAAM,CAAC,WAAW,CAAC,GAAG,QAAQ,CAAC,OAAO,WAAW;IACpE,OAAO,CAAC,KAAK,EAAE,QAAQ,CAAC,EAAE,YAAY;AACxC;AAEO,SAAS,oBAAoB,IAAY;IAC9C,MAAM,UAAU,KAAK,SAAS,CAAC;IAC/B,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,WAAW,MAAM,CAAC,SAAS,MAAM,CAAC;AACvE;AAEO,SAAS,kBAAkB,IAAY,EAAE,SAAiB;IAC/D,MAAM,oBAAoB,oBAAoB;IAC9C,OAAO,gHAAM,CAAC,eAAe,CAAC,OAAO,IAAI,CAAC,YAAY,OAAO,IAAI,CAAC;AACpE;AAEO,SAAS,iBACd,SAAiB,EACjB,SAAiB,EACjB,MAAc,EACd,SAAiB,EACjB,YAAoB,EACpB,YAAoB,EACpB,KAA8D;IAE9D,MAAM,uBAAuB;QAC3B,YAAY;QACZ;QACA,SAAS;QACT,YAAY;QACZ,eAAe;QACf,eAAe;QACf;QACA,YAAY;IACd;IAEA,MAAM,YAAY,oBAAoB;IAEtC,OAAO;QACL,GAAG,oBAAoB;QACvB;IACF;AACF;AAEO,SAAS,YAAY,MAAc;IACxC,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;QACV,uBAAuB;QACvB,uBAAuB;IACzB,GAAG,MAAM,CAAC;AACZ;AAEO,SAAS,WAAW,UAAkB;IAC3C,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,SAAS;QACT,MAAM;QACN,OAAO;QACP,KAAK;IACP,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAEO,SAAS,WAAW,UAAkB;IAC3C,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,MAAM;QACN,QAAQ;IACV,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAEO,SAAS,eAAe,UAAkB;IAC/C,OAAO,GAAG,WAAW,YAAY,KAAK,EAAE,WAAW,aAAa;AAClE"}},
    {"offset": {"line": 177, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/email/send-ticket-email.tsx"],"sourcesContent":["import { formatDate, formatTime, formatPrice } from \"@/lib/utils/booking\"\n\ninterface TicketEmailData {\n  customerName: string\n  customerEmail: string\n  bookingReference: string\n  showTitle: string\n  showDatetime: string\n  venueName: string\n  venueAddress: string\n  seats: Array<{ section: string; row: string; number: number; price_nok: number }>\n  totalAmount: number\n  qrCodeData: string\n}\n\nexport async function sendTicketEmail(data: TicketEmailData): Promise<{ success: boolean; error?: string }> {\n  console.log(\"[v0] ========== EMAIL SEND START ==========\")\n  console.log(\"[v0] sendTicketEmail called with:\", {\n    customerEmail: data.customerEmail,\n    bookingReference: data.bookingReference,\n    showTitle: data.showTitle,\n  })\n\n  const brevoApiKey = process.env.BREVO_API_KEY\n  const fromEmail = process.env.BREVO_FROM_EMAIL || \"noreply@teateret.no\"\n  const fromName = process.env.BREVO_FROM_NAME || \"Teateret\"\n\n  console.log(\"[v0] Environment check:\")\n  console.log(\"[v0] - BREVO_API_KEY exists:\", !!brevoApiKey)\n  console.log(\"[v0] - FROM_EMAIL:\", fromEmail)\n  console.log(\"[v0] - FROM_NAME:\", fromName)\n\n  if (!brevoApiKey) {\n    console.error(\"[v0] ERROR: BREVO_API_KEY is not set!\")\n    return { success: false, error: \"E-post er ikke konfigurert (mangler BREVO_API_KEY)\" }\n  }\n\n  try {\n    // Generate QR code as data URL for embedding in email\n    console.log(\"[v0] Generating QR code...\")\n    const QRCode = await import(\"qrcode\")\n    const qrCodeDataUrl = await QRCode.toDataURL(data.qrCodeData, {\n      width: 200,\n      margin: 2,\n    })\n    console.log(\"[v0] QR code generated successfully\")\n\n    const seatsHtml = data.seats\n      .map(\n        (seat) => `\n        <tr>\n          <td style=\"padding: 8px; border-bottom: 1px solid #e5e5e5;\">${seat.section}, Rad ${seat.row}, Sete ${seat.number}</td>\n          <td style=\"padding: 8px; border-bottom: 1px solid #e5e5e5; text-align: right;\">${formatPrice(seat.price_nok)}</td>\n        </tr>\n      `,\n      )\n      .join(\"\")\n\n    const emailHtml = `\n<!DOCTYPE html>\n<html lang=\"no\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Din billett - ${data.bookingReference}</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n    <div style=\"background: #1a1a2e; color: white; padding: 30px; text-align: center; border-radius: 12px 12px 0 0;\">\n      <h1 style=\"margin: 0 0 10px 0;\">Teateret</h1>\n      <p style=\"margin: 0;\">Din billett er klar!</p>\n    </div>\n    <div style=\"background: white; padding: 30px; border-radius: 0 0 12px 12px;\">\n      <p>Hei ${data.customerName},</p>\n      <p>Takk for din bestilling! Her er din billett til <strong>${data.showTitle}</strong>.</p>\n      \n      <div style=\"background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; margin: 25px 0;\">\n        <p style=\"margin: 0 0 5px 0; font-size: 14px; color: #666;\">Bestillingsreferanse</p>\n        <p style=\"margin: 0; font-size: 28px; font-weight: bold; font-family: monospace;\">${data.bookingReference}</p>\n      </div>\n\n      <div style=\"text-align: center; margin: 25px 0;\">\n        <p style=\"margin: 0 0 15px 0; color: #666;\">Vis denne QR-koden ved inngangen</p>\n        <img src=\"${qrCodeDataUrl}\" alt=\"QR-kode\" style=\"width: 200px; height: 200px;\" />\n      </div>\n\n      <div style=\"background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 25px 0;\">\n        <h2 style=\"margin: 0 0 15px 0;\">${data.showTitle}</h2>\n        <p><strong>Dato:</strong> ${formatDate(data.showDatetime)}</p>\n        <p><strong>Tid:</strong> kl. ${formatTime(data.showDatetime)}</p>\n        <p><strong>Sted:</strong> ${data.venueName}</p>\n        <p style=\"color: #666; font-size: 14px;\">${data.venueAddress}</p>\n      </div>\n\n      <h3>Dine seter</h3>\n      <table style=\"width: 100%; border-collapse: collapse;\">\n        ${seatsHtml}\n        <tr style=\"font-weight: bold;\">\n          <td style=\"padding: 12px 8px; border-top: 2px solid #1a1a2e;\">Totalt</td>\n          <td style=\"padding: 12px 8px; border-top: 2px solid #1a1a2e; text-align: right;\">${formatPrice(data.totalAmount)}</td>\n        </tr>\n      </table>\n\n      <div style=\"background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 25px 0;\">\n        <p style=\"margin: 0; font-size: 14px; color: #856404;\">\n          <strong>Viktig:</strong> Møt opp minst 15 minutter før forestillingen starter.\n        </p>\n      </div>\n\n      <p style=\"text-align: center; color: #666;\">Vi gleder oss til å se deg!</p>\n    </div>\n  </div>\n</body>\n</html>\n    `\n\n    console.log(\"[v0] Sending email via Brevo REST API...\")\n    console.log(\"[v0] - To:\", data.customerEmail)\n    console.log(\"[v0] - From:\", `${fromName} <${fromEmail}>`)\n    console.log(\"[v0] - Subject:\", `Din billett til ${data.showTitle} - ${data.bookingReference}`)\n\n    const response = await fetch(\"https://api.brevo.com/v3/smtp/email\", {\n      method: \"POST\",\n      headers: {\n        \"api-key\": brevoApiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        sender: {\n          name: fromName,\n          email: fromEmail,\n        },\n        to: [\n          {\n            email: data.customerEmail,\n            name: data.customerName,\n          },\n        ],\n        subject: `Din billett til ${data.showTitle} - ${data.bookingReference}`,\n        htmlContent: emailHtml,\n      }),\n    })\n\n    if (!response.ok) {\n      const errorData = await response.json()\n      console.error(\"[v0] Brevo API error:\", errorData)\n      throw new Error(`Brevo API error: ${response.status} - ${JSON.stringify(errorData)}`)\n    }\n\n    const result = await response.json()\n\n    console.log(\"[v0] Email sent successfully!\")\n    console.log(\"[v0] Message ID:\", result.messageId)\n    console.log(\"[v0] ========== EMAIL SEND COMPLETE ==========\")\n\n    return { success: true }\n  } catch (error) {\n    console.error(\"[v0] ========== EMAIL SEND ERROR ==========\")\n    console.error(\"[v0] Error type:\", typeof error)\n    console.error(\"[v0] Error:\", error)\n    if (error instanceof Error) {\n      console.error(\"[v0] Error message:\", error.message)\n      console.error(\"[v0] Error stack:\", error.stack)\n    }\n    return { success: false, error: error instanceof Error ? error.message : \"Ukjent feil ved e-postsending\" }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 331, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/app/api/bookings/create/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { getSupabaseAdminClient, getSupabaseServerClient } from \"@/lib/supabase/server\"\nimport type { Seat } from \"@/lib/types\"\nimport { generateBookingReference, createQRCodeData } from \"@/lib/utils/booking\"\nimport { sendTicketEmail } from \"@/lib/email/send-ticket-email\"\n\nexport async function POST(request: NextRequest) {\n  console.log(\"[v0] ========== BOOKING CREATE START ==========\")\n\n  try {\n    const body = await request.json()\n    const { showId, seatIds, customerName, customerEmail, customerPhone, specialRequests, totalAmount } = body\n\n    console.log(\"[v0] Booking request:\", { showId, seatIds, customerName, customerEmail, totalAmount })\n\n    if (!showId || !seatIds || !customerName || !customerEmail || !totalAmount) {\n      return NextResponse.json({ error: \"Manglende påkrevde felt\" }, { status: 400 })\n    }\n\n    // Get current user from regular server client (has session context)\n    const serverClient = await getSupabaseServerClient()\n    const {\n      data: { user },\n    } = await serverClient.auth.getUser()\n\n    if (!user?.id) {\n      console.log(\"[v0] Authentication failed - no user\")\n      return NextResponse.json(\n        { error: \"Du må være logget inn for å bestille billetter\" },\n        { status: 401 }\n      )\n    }\n\n    console.log(\"[v0] Booking for user:\", user.id)\n\n    // Use admin client for database operations (bypasses RLS)\n    const supabase = await getSupabaseAdminClient()\n\n    // Get show details\n    const { data: show, error: showError } = await supabase\n      .from(\"shows\")\n      .select(`\n        *,\n        ensemble:ensembles(*),\n        venue:venues(*)\n      `)\n      .eq(\"id\", showId)\n      .single()\n\n    if (showError || !show) {\n      console.error(\"[v0] Show error:\", showError)\n      return NextResponse.json({ error: \"Forestilling ikke funnet\" }, { status: 404 })\n    }\n\n    console.log(\"[v0] Show found:\", show.id)\n\n  const { data: seats, error: seatsError } = await supabase.from(\"seats\").select(\"*\").in(\"id\", seatIds)\n\n    if (seatsError || !seats) {\n      console.error(\"[v0] Seats fetch error:\", seatsError)\n      return NextResponse.json({ error: \"Kunne ikke hente setedata\" }, { status: 500 })\n    }\n\n  console.log(\n    \"[v0] Seats fetched for booking:\",\n    seats?.map((s: Seat) => ({ id: s.id, status: s.status, reserved_until: s.reserved_until })),\n  )\n\n  // Check that we got all requested seats\n  if (seats.length !== seatIds.length) {\n      return NextResponse.json({ error: \"Noen av setene finnes ikke\" }, { status: 400 })\n    }\n\n  const unavailableSeats = seats.filter((s: Seat) => s.status !== \"reserved\" && s.status !== \"available\")\n    if (unavailableSeats.length > 0) {\n  const soldCount = unavailableSeats.filter((s: Seat) => s.status === \"sold\").length\n  const blockedCount = unavailableSeats.filter((s: Seat) => s.status === \"blocked\").length\n\n      let errorMsg = \"Noen av setene er ikke lenger tilgjengelige\"\n      if (soldCount > 0) errorMsg = `${soldCount} av setene er allerede solgt`\n      if (blockedCount > 0) errorMsg = `${blockedCount} av setene er blokkert`\n\n      return NextResponse.json({ error: errorMsg }, { status: 400 })\n    }\n\n    // Generate booking reference\n    const bookingReference = generateBookingReference()\n    console.log(\"[v0] Generated booking reference:\", bookingReference)\n\n    // Create QR code data\n    const showTitle = show.title || show.ensemble?.title || \"Forestilling\"\n    const qrData = createQRCodeData(\n      \"\", // Will be updated after insert\n      bookingReference,\n      showId,\n      showTitle,\n      show.show_datetime,\n      customerName,\n      seats.map((s: Seat) => ({ section: s.section, row: s.row, number: s.number })),\n    )\n\n    // Create booking\n    const { data: booking, error: bookingError } = await supabase\n      .from(\"bookings\")\n      .insert({\n        user_id: user.id,\n        show_id: showId,\n        seat_ids: seatIds,\n        total_amount_nok: totalAmount,\n        booking_reference: bookingReference,\n        qr_code_data: JSON.stringify(qrData),\n        customer_name: customerName,\n        customer_email: customerEmail,\n        customer_phone: customerPhone || null,\n        special_requests: specialRequests || null,\n        status: \"confirmed\", // Mock payment - directly confirmed\n        confirmed_at: new Date().toISOString(),\n        ticket_sent: false,\n      })\n      .select()\n      .single()\n\n    if (bookingError) {\n      console.error(\"[v0] Booking error:\", bookingError)\n      return NextResponse.json({ error: \"Kunne ikke opprette bestilling: \" + bookingError.message }, { status: 500 })\n    }\n\n    console.log(\"[v0] Booking created:\", booking.id, \"Reference:\", booking.booking_reference, \"User ID:\", booking.user_id)\n\n    // Update QR data with booking ID\n    const updatedQrData = { ...qrData, booking_id: booking.id }\n    const qrCodeDataString = JSON.stringify(updatedQrData)\n\n    await supabase.from(\"bookings\").update({ qr_code_data: qrCodeDataString }).eq(\"id\", booking.id)\n\n    const { error: updateSeatsError } = await supabase\n      .from(\"seats\")\n      .update({ status: \"sold\", reserved_until: null })\n      .in(\"id\", seatIds)\n\n    if (updateSeatsError) {\n      console.error(\"[v0] Update seats error:\", updateSeatsError)\n    }\n\n    // Update available seats count\n    await supabase\n      .from(\"shows\")\n      .update({ available_seats: show.available_seats - seatIds.length })\n      .eq(\"id\", showId)\n\n    console.log(\"[v0] ========== STARTING EMAIL SEND ==========\")\n    console.log(\"[v0] Calling sendTicketEmail function...\")\n\n  let emailResult: { success: boolean; error?: string } = { success: false }\n\n    try {\n      emailResult = await sendTicketEmail({\n        customerName,\n        customerEmail,\n        bookingReference,\n        showTitle,\n        showDatetime: show.show_datetime,\n        venueName: show.venue?.name || \"Ukjent lokale\",\n        venueAddress: show.venue ? `${show.venue.address}, ${show.venue.postal_code} ${show.venue.city}` : \"\",\n        seats: seats.map((s: Seat) => ({\n          section: s.section,\n          row: s.row,\n          number: s.number,\n          price_nok: s.price_nok,\n        })),\n        totalAmount,\n        qrCodeData: qrCodeDataString,\n      })\n\n      console.log(\"[v0] sendTicketEmail returned:\", emailResult)\n    } catch (emailError) {\n      console.error(\"[v0] sendTicketEmail threw an error:\", emailError)\n      emailResult = {\n        success: false,\n        error: emailError instanceof Error ? emailError.message : \"Ukjent feil i e-postsending\",\n      }\n    }\n\n    // Update ticket_sent status\n    await supabase.from(\"bookings\").update({ ticket_sent: emailResult.success }).eq(\"id\", booking.id)\n\n    if (!emailResult.success) {\n      console.error(\"[v0] Email sending failed:\", emailResult.error)\n    } else {\n      console.log(\"[v0] Email sent successfully!\")\n    }\n\n    console.log(\"[v0] ========== BOOKING CREATE COMPLETE ==========\")\n\n    return NextResponse.json({\n      success: true,\n      bookingId: booking.id,\n      bookingReference,\n      emailSent: emailResult.success,\n      emailError: emailResult.error,\n    })\n  } catch (error) {\n    console.error(\"[v0] ========== BOOKING CREATE ERROR ==========\")\n    console.error(\"[v0] Booking creation error:\", error)\n    return NextResponse.json({ error: \"Intern serverfeil\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}