{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { createClient } from \"@supabase/supabase-js\"\nimport { cookies } from \"next/headers\"\n\nexport async function getSupabaseServerClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Server Component - ignore\n        }\n      },\n    },\n  })\n}\n\nexport async function getSupabaseAdminClient() {\n  // Use createClient with service role key to bypass RLS\n  // Do NOT use createServerClient with service role key - it still respects RLS\n  return createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,4BAA4B;gBAC9B;YACF;QACF;IACF;AACF;AAEO,eAAe;IACpB,uDAAuD;IACvD,8EAA8E;IAC9E,OAAO,IAAA,yLAAY,gFAAwC,QAAQ,GAAG,CAAC,yBAAyB,EAAG;QACjG,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/utils/booking.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nconst QR_SECRET = process.env.QR_SIGNING_SECRET || \"default-secret-change-in-production\"\n\nexport function generateBookingReference(): string {\n  const date = new Date()\n  const dateStr = date.toISOString().slice(0, 10).replace(/-/g, \"\")\n  const randomPart = crypto.randomBytes(2).toString(\"hex\").toUpperCase()\n  return `THTR-${dateStr}-${randomPart}`\n}\n\nexport function generateQRSignature(data: object): string {\n  const payload = JSON.stringify(data)\n  return crypto.createHmac(\"sha256\", QR_SECRET).update(payload).digest(\"hex\")\n}\n\nexport function verifyQRSignature(data: object, signature: string): boolean {\n  const expectedSignature = generateQRSignature(data)\n  return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSignature))\n}\n\nexport function createQRCodeData(\n  bookingId: string,\n  reference: string,\n  showId: string,\n  showTitle: string,\n  showDatetime: string,\n  customerName: string,\n  seats: Array<{ section: string; row: string; number: number }>,\n) {\n  const dataWithoutSignature = {\n    booking_id: bookingId,\n    reference,\n    show_id: showId,\n    show_title: showTitle,\n    show_datetime: showDatetime,\n    customer_name: customerName,\n    seats,\n    checked_in: false,\n  }\n\n  const signature = generateQRSignature(dataWithoutSignature)\n\n  return {\n    ...dataWithoutSignature,\n    signature,\n  }\n}\n\nexport function formatPrice(amount: number): string {\n  return new Intl.NumberFormat(\"nb-NO\", {\n    style: \"currency\",\n    currency: \"NOK\",\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0,\n  }).format(amount)\n}\n\nexport function formatDate(dateString: string): string {\n  return new Intl.DateTimeFormat(\"nb-NO\", {\n    weekday: \"long\",\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  }).format(new Date(dateString))\n}\n\nexport function formatTime(dateString: string): string {\n  return new Intl.DateTimeFormat(\"nb-NO\", {\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  }).format(new Date(dateString))\n}\n\nexport function formatDateTime(dateString: string): string {\n  return `${formatDate(dateString)} kl. ${formatTime(dateString)}`\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;AAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,iBAAiB,IAAI;AAE5C,SAAS;IACd,MAAM,OAAO,IAAI;IACjB,MAAM,UAAU,KAAK,WAAW,GAAG,KAAK,CAAC,GAAG,IAAI,OAAO,CAAC,MAAM;IAC9D,MAAM,aAAa,gHAAM,CAAC,WAAW,CAAC,GAAG,QAAQ,CAAC,OAAO,WAAW;IACpE,OAAO,CAAC,KAAK,EAAE,QAAQ,CAAC,EAAE,YAAY;AACxC;AAEO,SAAS,oBAAoB,IAAY;IAC9C,MAAM,UAAU,KAAK,SAAS,CAAC;IAC/B,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,WAAW,MAAM,CAAC,SAAS,MAAM,CAAC;AACvE;AAEO,SAAS,kBAAkB,IAAY,EAAE,SAAiB;IAC/D,MAAM,oBAAoB,oBAAoB;IAC9C,OAAO,gHAAM,CAAC,eAAe,CAAC,OAAO,IAAI,CAAC,YAAY,OAAO,IAAI,CAAC;AACpE;AAEO,SAAS,iBACd,SAAiB,EACjB,SAAiB,EACjB,MAAc,EACd,SAAiB,EACjB,YAAoB,EACpB,YAAoB,EACpB,KAA8D;IAE9D,MAAM,uBAAuB;QAC3B,YAAY;QACZ;QACA,SAAS;QACT,YAAY;QACZ,eAAe;QACf,eAAe;QACf;QACA,YAAY;IACd;IAEA,MAAM,YAAY,oBAAoB;IAEtC,OAAO;QACL,GAAG,oBAAoB;QACvB;IACF;AACF;AAEO,SAAS,YAAY,MAAc;IACxC,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;QACV,uBAAuB;QACvB,uBAAuB;IACzB,GAAG,MAAM,CAAC;AACZ;AAEO,SAAS,WAAW,UAAkB;IAC3C,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,SAAS;QACT,MAAM;QACN,OAAO;QACP,KAAK;IACP,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAEO,SAAS,WAAW,UAAkB;IAC3C,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,MAAM;QACN,QAAQ;IACV,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAEO,SAAS,eAAe,UAAkB;IAC/C,OAAO,GAAG,WAAW,YAAY,KAAK,EAAE,WAAW,aAAa;AAClE"}},
    {"offset": {"line": 261, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/email/send-ticket-email.tsx"],"sourcesContent":["'use server'\n\nimport nodemailer from 'nodemailer'\nimport { formatDate, formatTime, formatPrice } from '@/lib/utils/booking'\n\ninterface TicketEmailData {\n  customerName: string\n  customerEmail: string\n  bookingReference: string\n  showTitle: string\n  showDatetime: string\n  venueName: string\n  venueAddress: string\n  seats: Array<{ section: string; row: string; number: number; price_nok: number }>\n  totalAmount: number\n  qrCodeData: string\n}\n\nlet transporter: nodemailer.Transporter | null = null\n\nfunction getTransporter() {\n  if (!transporter) {\n    transporter = nodemailer.createTransport({\n      host: process.env.SMTP_SERVER,\n      port: parseInt(process.env.SMTP_PORT || '587'),\n      secure: false,\n      auth: {\n        user: process.env.SMTP_LOGIN,\n        pass: process.env.SMTP_PASSWORD,\n      },\n    })\n  }\n  return transporter\n}\n\nexport async function sendTicketEmail(data: TicketEmailData): Promise<{ success: boolean; error?: string }> {\n  console.log('[v0] ========== EMAIL SEND START ==========')\n  console.log('[v0] sendTicketEmail called with:', {\n    customerEmail: data.customerEmail,\n    bookingReference: data.bookingReference,\n    showTitle: data.showTitle,\n  })\n\n  const fromEmail = process.env.BREVO_FROM_EMAIL || 'noreply@teateret.no'\n  const fromName = process.env.BREVO_FROM_NAME || 'Teateret'\n\n  console.log('[v0] Email configuration:')\n  console.log('[v0] - FROM_EMAIL:', fromEmail)\n  console.log('[v0] - FROM_NAME:', fromName)\n  console.log('[v0] - SMTP_SERVER:', process.env.SMTP_SERVER)\n\n  if (!process.env.SMTP_SERVER || !process.env.SMTP_LOGIN || !process.env.SMTP_PASSWORD) {\n    console.error('[v0] ERROR: SMTP credentials not configured!')\n    return { success: false, error: 'E-post er ikke konfigurert (mangler SMTP credentials)' }\n  }\n\n  try {\n    // Generate QR code as buffer for embedding in email\n    console.log('[v0] Generating QR code...')\n    const QRCode = await import('qrcode')\n    const qrCodeBuffer = await QRCode.toBuffer(data.qrCodeData, {\n      width: 200,\n      margin: 2,\n    })\n    console.log('[v0] QR code generated successfully')\n\n    const seatsHtml = data.seats\n      .map(\n        (seat) => `\n        <tr style=\"border-bottom: 1px solid #e0e0e0;\">\n          <td style=\"padding: 8px; text-align: left;\">${seat.section}</td>\n          <td style=\"padding: 8px; text-align: center;\">${seat.row}</td>\n          <td style=\"padding: 8px; text-align: center;\">${seat.number}</td>\n          <td style=\"padding: 8px; text-align: right;\">${formatPrice(seat.price_nok)}</td>\n        </tr>\n      `,\n      )\n      .join('')\n\n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 0; padding: 0;\">\n          <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px;\">üé≠ Din billett er klar!</h1>\n          </div>\n          \n          <div style=\"max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n            \n            <p style=\"color: #333; margin-bottom: 20px;\">Hei ${data.customerName},</p>\n            \n            <p style=\"color: #555; margin-bottom: 20px;\">\n              Takk for at du bestilte billetter til ${data.showTitle}! Her er din billett med QR-kode.\n            </p>\n\n            <!-- Booking Reference -->\n            <div style=\"background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; text-align: center;\">\n              <p style=\"color: #666; font-size: 12px; margin: 0 0 8px 0; text-transform: uppercase;\">Bokingsreferanse</p>\n              <p style=\"color: #333; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; margin: 0; letter-spacing: 2px;\">\n                ${data.bookingReference}\n              </p>\n            </div>\n\n            <!-- QR Code -->\n            <div style=\"text-align: center; margin: 30px 0;\">\n              <img src=\"cid:qrcode\" alt=\"QR Code\" style=\"width: 200px; height: 200px; border-radius: 8px;\">\n              <p style=\"color: #999; font-size: 12px; margin: 10px 0 0 0;\">Vis denne koden ved inngang</p>\n            </div>\n\n            <!-- Show Details -->\n            <div style=\"background: #f0f7ff; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n              <h3 style=\"color: #333; margin-top: 0; margin-bottom: 12px;\">Arrangement</h3>\n              <table style=\"width: 100%; color: #555;\">\n                <tr style=\"border-bottom: 1px solid #ddd;\">\n                  <td style=\"padding: 8px 0; padding-right: 10px; font-weight: 500;\">Forestilling:</td>\n                  <td style=\"padding: 8px 0; text-align: right;\"><strong>${data.showTitle}</strong></td>\n                </tr>\n                <tr style=\"border-bottom: 1px solid #ddd;\">\n                  <td style=\"padding: 8px 0; padding-right: 10px;\">Dato & tid:</td>\n                  <td style=\"padding: 8px 0; text-align: right;\">${formatDate(data.showDatetime)} kl. ${formatTime(data.showDatetime)}</td>\n                </tr>\n                <tr style=\"border-bottom: 1px solid #ddd;\">\n                  <td style=\"padding: 8px 0; padding-right: 10px;\">Sted:</td>\n                  <td style=\"padding: 8px 0; text-align: right;\"><strong>${data.venueName}</strong></td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 8px 0; padding-right: 10px;\">Adresse:</td>\n                  <td style=\"padding: 8px 0; text-align: right;\">${data.venueAddress}</td>\n                </tr>\n              </table>\n            </div>\n\n            <!-- Seats Table -->\n            <div style=\"margin: 20px 0;\">\n              <h3 style=\"color: #333; margin-top: 0; margin-bottom: 12px;\">Billetter</h3>\n              <table style=\"width: 100%; border-collapse: collapse; color: #555;\">\n                <thead>\n                  <tr style=\"background: #f0f7ff; border-bottom: 2px solid #667eea;\">\n                    <th style=\"padding: 10px; text-align: left; font-weight: 600; color: #333;\">Seksjon</th>\n                    <th style=\"padding: 10px; text-align: center; font-weight: 600; color: #333;\">Rad</th>\n                    <th style=\"padding: 10px; text-align: center; font-weight: 600; color: #333;\">Sete</th>\n                    <th style=\"padding: 10px; text-align: right; font-weight: 600; color: #333;\">Pris</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${seatsHtml}\n                </tbody>\n              </table>\n            </div>\n\n            <!-- Total -->\n            <div style=\"background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; text-align: right;\">\n              <p style=\"color: #666; margin: 0 0 8px 0;\">Totalpris:</p>\n              <p style=\"color: #667eea; font-size: 24px; font-weight: bold; margin: 0;\">\n                ${formatPrice(data.totalAmount)}\n              </p>\n            </div>\n\n            <!-- Important Note -->\n            <div style=\"background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin: 20px 0;\">\n              <p style=\"color: #856404; margin: 0; font-weight: 500;\">\n                ‚è∞ Vennligst m√∏t 15 minutter f√∏r forestillingen starter.\n              </p>\n            </div>\n\n            <p style=\"color: #777; font-size: 13px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;\">\n              Lurer du p√• noe? Bes√∏k v√•re nettsider eller kontakt v√•r kundeservice.\n            </p>\n\n            <p style=\"color: #999; font-size: 12px; margin: 10px 0 0 0;\">\n              Med vennlig hilsen,<br>\n              <strong>Teateret</strong>\n            </p>\n          </div>\n        </body>\n      </html>\n    `\n\n    const transporter = getTransporter()\n\n    console.log('[v0] Sending email via SMTP...')\n    console.log('[v0] - To:', data.customerEmail)\n    console.log('[v0] - From:', `${fromName} <${fromEmail}>`)\n\n    const info = await transporter.sendMail({\n      from: `${fromName} <${fromEmail}>`,\n      to: data.customerEmail,\n      subject: `Din billett til ${data.showTitle} - ${data.bookingReference}`,\n      html: emailHtml,\n      attachments: [\n        {\n          filename: 'qrcode.png',\n          content: qrCodeBuffer,\n          cid: 'qrcode',\n        },\n      ],\n    })\n\n    console.log('[v0] Email sent successfully!')\n    console.log('[v0] Message ID:', info.messageId)\n    console.log('[v0] Response:', info.response)\n    console.log('[v0] ========== EMAIL SEND COMPLETE ==========')\n\n    return { success: true }\n  } catch (error) {\n    console.error('[v0] ========== EMAIL SEND ERROR ==========')\n    console.error('[v0] Error type:', typeof error)\n    console.error('[v0] Error:', error)\n    if (error instanceof Error) {\n      console.error('[v0] Error message:', error.message)\n      console.error('[v0] Error stack:', error.stack)\n    }\n    return { success: false, error: error instanceof Error ? error.message : 'Ukjent feil ved e-postsending' }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 473, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/app/api/bookings/create/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { getSupabaseAdminClient, getSupabaseServerClient } from \"@/lib/supabase/server\"\nimport type { Seat } from \"@/lib/types\"\nimport { generateBookingReference, createQRCodeData } from \"@/lib/utils/booking\"\nimport { sendTicketEmail } from \"@/lib/email/send-ticket-email\"\n\nexport async function POST(request: NextRequest) {\n  console.log(\"[v0] ========== BOOKING CREATE START ==========\")\n\n  try {\n    const body = await request.json()\n    const { showId, seatIds, customerName, customerEmail, customerPhone, specialRequests, totalAmount } = body\n\n    console.log(\"[v0] Booking request:\", { showId, seatIds, customerName, customerEmail, totalAmount })\n\n    if (!showId || !seatIds || !customerName || !customerEmail || !totalAmount) {\n      return NextResponse.json({ error: \"Manglende p√•krevde felt\" }, { status: 400 })\n    }\n\n    // Get current user from regular server client (has session context)\n    const serverClient = await getSupabaseServerClient()\n    const {\n      data: { user },\n    } = await serverClient.auth.getUser()\n\n    if (!user?.id) {\n      console.log(\"[v0] Authentication failed - no user\")\n      return NextResponse.json(\n        { error: \"Du m√• v√¶re logget inn for √• bestille billetter\" },\n        { status: 401 }\n      )\n    }\n\n    console.log(\"[v0] Booking for user:\", user.id)\n\n    // Use admin client for database operations (bypasses RLS)\n    const supabase = await getSupabaseAdminClient()\n\n    // Get show details\n    const { data: show, error: showError } = await supabase\n      .from(\"shows\")\n      .select(`\n        *,\n        ensemble:ensembles(*),\n        venue:venues(*)\n      `)\n      .eq(\"id\", showId)\n      .single()\n\n    if (showError || !show) {\n      console.error(\"[v0] Show error:\", showError)\n      return NextResponse.json({ error: \"Forestilling ikke funnet\" }, { status: 404 })\n    }\n\n    console.log(\"[v0] Show found:\", show.id)\n\n  const { data: seats, error: seatsError } = await supabase.from(\"seats\").select(\"*\").in(\"id\", seatIds)\n\n    if (seatsError || !seats) {\n      console.error(\"[v0] Seats fetch error:\", seatsError)\n      return NextResponse.json({ error: \"Kunne ikke hente setedata\" }, { status: 500 })\n    }\n\n  console.log(\n    \"[v0] Seats fetched for booking:\",\n    seats?.map((s: Seat) => ({ id: s.id, status: s.status, reserved_until: s.reserved_until })),\n  )\n\n  // Check that we got all requested seats\n  if (seats.length !== seatIds.length) {\n      return NextResponse.json({ error: \"Noen av setene finnes ikke\" }, { status: 400 })\n    }\n\n  const unavailableSeats = seats.filter((s: Seat) => s.status !== \"reserved\" && s.status !== \"available\")\n    if (unavailableSeats.length > 0) {\n  const soldCount = unavailableSeats.filter((s: Seat) => s.status === \"sold\").length\n  const blockedCount = unavailableSeats.filter((s: Seat) => s.status === \"blocked\").length\n\n      let errorMsg = \"Noen av setene er ikke lenger tilgjengelige\"\n      if (soldCount > 0) errorMsg = `${soldCount} av setene er allerede solgt`\n      if (blockedCount > 0) errorMsg = `${blockedCount} av setene er blokkert`\n\n      return NextResponse.json({ error: errorMsg }, { status: 400 })\n    }\n\n    // Generate booking reference\n    const bookingReference = generateBookingReference()\n    console.log(\"[v0] Generated booking reference:\", bookingReference)\n\n    // Create QR code data\n    const showTitle = show.title || show.ensemble?.title || \"Forestilling\"\n    const qrData = createQRCodeData(\n      \"\", // Will be updated after insert\n      bookingReference,\n      showId,\n      showTitle,\n      show.show_datetime,\n      customerName,\n      seats.map((s: Seat) => ({ section: s.section, row: s.row, number: s.number })),\n    )\n\n    // Create booking\n    const { data: booking, error: bookingError } = await supabase\n      .from(\"bookings\")\n      .insert({\n        user_id: user.id,\n        show_id: showId,\n        seat_ids: seatIds,\n        total_amount_nok: totalAmount,\n        booking_reference: bookingReference,\n        qr_code_data: JSON.stringify(qrData),\n        customer_name: customerName,\n        customer_email: customerEmail,\n        customer_phone: customerPhone || null,\n        special_requests: specialRequests || null,\n        status: \"confirmed\", // Mock payment - directly confirmed\n        confirmed_at: new Date().toISOString(),\n        ticket_sent: false,\n      })\n      .select()\n      .single()\n\n    if (bookingError) {\n      console.error(\"[v0] Booking error:\", bookingError)\n      return NextResponse.json({ error: \"Kunne ikke opprette bestilling: \" + bookingError.message }, { status: 500 })\n    }\n\n    console.log(\"[v0] Booking created:\", booking.id, \"Reference:\", booking.booking_reference, \"User ID:\", booking.user_id)\n\n    // Update QR data with booking ID\n    const updatedQrData = { ...qrData, booking_id: booking.id }\n    const qrCodeDataString = JSON.stringify(updatedQrData)\n\n    await supabase.from(\"bookings\").update({ qr_code_data: qrCodeDataString }).eq(\"id\", booking.id)\n\n    const { error: updateSeatsError } = await supabase\n      .from(\"seats\")\n      .update({ status: \"sold\", reserved_until: null })\n      .in(\"id\", seatIds)\n\n    if (updateSeatsError) {\n      console.error(\"[v0] Update seats error:\", updateSeatsError)\n    }\n\n    // Update available seats count\n    await supabase\n      .from(\"shows\")\n      .update({ available_seats: show.available_seats - seatIds.length })\n      .eq(\"id\", showId)\n\n    console.log(\"[v0] ========== STARTING EMAIL SEND ==========\")\n    console.log(\"[v0] Calling sendTicketEmail function...\")\n\n  let emailResult: { success: boolean; error?: string } = { success: false }\n\n    try {\n      emailResult = await sendTicketEmail({\n        customerName,\n        customerEmail,\n        bookingReference,\n        showTitle,\n        showDatetime: show.show_datetime,\n        venueName: show.venue?.name || \"Ukjent lokale\",\n        venueAddress: show.venue ? `${show.venue.address}, ${show.venue.postal_code} ${show.venue.city}` : \"\",\n        seats: seats.map((s: Seat) => ({\n          section: s.section,\n          row: s.row,\n          number: s.number,\n          price_nok: s.price_nok,\n        })),\n        totalAmount,\n        qrCodeData: qrCodeDataString,\n      })\n\n      console.log(\"[v0] sendTicketEmail returned:\", emailResult)\n    } catch (emailError) {\n      console.error(\"[v0] sendTicketEmail threw an error:\", emailError)\n      emailResult = {\n        success: false,\n        error: emailError instanceof Error ? emailError.message : \"Ukjent feil i e-postsending\",\n      }\n    }\n\n    // Update ticket_sent status\n    await supabase.from(\"bookings\").update({ ticket_sent: emailResult.success }).eq(\"id\", booking.id)\n\n    if (!emailResult.success) {\n      console.error(\"[v0] Email sending failed:\", emailResult.error)\n    } else {\n      console.log(\"[v0] Email sent successfully!\")\n    }\n\n    console.log(\"[v0] ========== BOOKING CREATE COMPLETE ==========\")\n\n    return NextResponse.json({\n      success: true,\n      bookingId: booking.id,\n      bookingReference,\n      emailSent: emailResult.success,\n      emailError: emailResult.error,\n    })\n  } catch (error) {\n    console.error(\"[v0] ========== BOOKING CREATE ERROR ==========\")\n    console.error(\"[v0] Booking creation error:\", error)\n    return NextResponse.json({ error: \"Intern serverfeil\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}