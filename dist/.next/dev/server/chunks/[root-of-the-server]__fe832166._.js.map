{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { createClient } from \"@supabase/supabase-js\"\nimport { cookies } from \"next/headers\"\n\nexport async function getSupabaseServerClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Server Component - ignore\n        }\n      },\n    },\n  })\n}\n\nexport async function getSupabaseAdminClient() {\n  // Use createClient with service role key to bypass RLS\n  // Do NOT use createServerClient with service role key - it still respects RLS\n  return createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,4BAA4B;gBAC9B;YACF;QACF;IACF;AACF;AAEO,eAAe;IACpB,uDAAuD;IACvD,8EAA8E;IAC9E,OAAO,IAAA,yLAAY,gFAAwC,QAAQ,GAAG,CAAC,yBAAyB,EAAG;QACjG,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Users/sondrey/Downloads/v0-teaterplattform-utviklingsplan-main%202/app/api/seats/reserve/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { getSupabaseAdminClient } from \"@/lib/supabase/server\"\nimport type { Seat } from \"@/lib/types\"\n\ntype PartialSeat = {\n  id: string\n  status?: string\n  reserved_until?: string | null\n  row?: string\n  number?: number\n  section?: string\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { seatIds, showId } = body\n\n    console.log(\"[v0] Reserve seats request\", { showId, seatIds })\n\n    if (!seatIds || !Array.isArray(seatIds) || seatIds.length === 0 || !showId) {\n      return NextResponse.json({ error: \"Manglende seatIds eller showId\" }, { status: 400 })\n    }\n\n    const supabase = await getSupabaseAdminClient()\n    const reservedUntil = new Date(Date.now() + 10 * 60 * 1000).toISOString() // 10 minutes\n\n    // Debug: Check if service role key is available\n    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\n      console.error(\"[v0] SUPABASE_SERVICE_ROLE_KEY not set - admin operations will fail\")\n      return NextResponse.json({ error: \"Server misconfiguration\" }, { status: 500 })\n    }\n\n    // First check current status of all seats\n    const { data: currentSeats, error: checkError } = await supabase\n      .from(\"seats\")\n      .select(\"id, status, reserved_until, row, number, section\")\n      .in(\"id\", seatIds)\n      .eq(\"show_id\", showId)\n\n    if (checkError) {\n      console.error(\"[v0] Check seats error:\", checkError)\n      return NextResponse.json({ error: \"Kunne ikke sjekke sete-status\" }, { status: 500 })\n    }\n\n    if (!currentSeats || currentSeats.length !== seatIds.length) {\n      console.warn(\"[v0] Seat count mismatch\", { requested: seatIds.length, found: currentSeats?.length, currentSeats })\n      return NextResponse.json({ error: \"Noen av setene finnes ikke\" }, { status: 400 })\n    }\n\n    console.log(\"[v0] Current seat states:\", currentSeats.map(s => ({ id: s.id, status: s.status, reserved_until: s.reserved_until })))\n\n    // Normalize and defensive-check seat statuses to avoid casing/null issues\n    const now = Date.now()\n\n    const expiredReservedIds: string[] = []\n\n    const unavailableSeats = (currentSeats as PartialSeat[]).filter((s) => {\n      // Normalize status values. If status is null/undefined, treat it as available\n      const st = ((s.status as string) || \"available\").toString().toLowerCase()\n\n      if (st === \"available\") return false\n\n      if (st === \"reserved\") {\n        // If reservation expired, consider it available and mark for cleanup\n        const until = s.reserved_until ? new Date(s.reserved_until).getTime() : 0\n        if (until && until > now) {\n          return true // still reserved\n        }\n\n        // expired reservation - collect for cleanup and treat as available\n        expiredReservedIds.push(s.id)\n        return false\n      }\n\n      // sold/blocked or any other status -> unavailable\n      return true\n    })\n\n    // Cleanup any expired reservations so they don't block users\n    if (expiredReservedIds.length > 0) {\n      console.log(\"[v0] Cleaning up expired reservations:\", expiredReservedIds)\n      try {\n        await supabase.from(\"seats\").update({ status: \"available\", reserved_until: null }).in(\"id\", expiredReservedIds)\n      } catch (e) {\n        console.warn(\"[v0] Failed to cleanup expired reservations\", { expiredReservedIds, error: e })\n      }\n    }\n    console.log(\"[v0] Unavailable seats check:\", { unavailableSeatIds: unavailableSeats.map(s => s.id), count: unavailableSeats.length })\n    if (unavailableSeats.length > 0) {\n      const seatList = unavailableSeats.map((s) => `Rad ${s.row}, Sete ${s.number}`).join(\", \")\n      console.log(\"[v0] Rejecting due to unavailable seats:\", { seatList, ids: unavailableSeats.map(s => s.id) })\n      return NextResponse.json(\n        {\n          error: `FÃ¸lgende seter er ikke tilgjengelige: ${seatList}`,\n          unavailableSeatIds: unavailableSeats.map((s) => s.id),\n        },\n        { status: 409 },\n      )\n    }\n\n\n    // Reserve all seats (only those still available) - include show_id filter for safety\n    const { data: updatedSeats, error: updateError } = await supabase\n      .from(\"seats\")\n      .update({ status: \"reserved\", reserved_until: reservedUntil })\n      .in(\"id\", seatIds)\n      .eq(\"show_id\", showId)\n      .eq(\"status\", \"available\")\n      .select(\"id\")\n\n    if (updateError) {\n      console.error(\"[v0] Update seats error:\", updateError)\n      console.error(\"[v0] Update error details:\", { code: updateError.code, message: updateError.message, details: (updateError as any).details })\n      return NextResponse.json({ error: \"Kunne ikke reservere setene\", details: updateError.message }, { status: 500 })\n    }\n\n    // Check if all seats were reserved\n    if (!updatedSeats || updatedSeats.length !== seatIds.length) {\n      // Some seats were taken between check and update - rollback\n      const reservedIds = (updatedSeats as { id: string }[])?.map((s) => s.id) || []\n      console.log(\"[v0] Partial update detected\", { requested: seatIds.length, updated: updatedSeats?.length, updatedIds: reservedIds })\n      if (reservedIds.length > 0) {\n        await supabase.from(\"seats\").update({ status: \"available\", reserved_until: null }).in(\"id\", reservedIds)\n      }\n\n      const failedCount = seatIds.length - (updatedSeats?.length || 0)\n      return NextResponse.json({ error: `${failedCount} av setene ble nettopp tatt av noen andre` }, { status: 409 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      reservedUntil,\n  seatIds: (updatedSeats as { id: string }[]).map((s) => s.id),\n    })\n  } catch (error) {\n    console.error(\"[v0] Reserve seats error:\", error)\n    return NextResponse.json({ error: \"Intern serverfeil\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAYO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG;QAE5B,QAAQ,GAAG,CAAC,8BAA8B;YAAE;YAAQ;QAAQ;QAE5D,IAAI,CAAC,WAAW,CAAC,MAAM,OAAO,CAAC,YAAY,QAAQ,MAAM,KAAK,KAAK,CAAC,QAAQ;YAC1E,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiC,GAAG;gBAAE,QAAQ;YAAI;QACtF;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAsB;QAC7C,MAAM,gBAAgB,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,MAAM,WAAW,GAAG,aAAa;;QAEvF,gDAAgD;QAChD,IAAI,CAAC,QAAQ,GAAG,CAAC,yBAAyB,EAAE;YAC1C,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,0CAA0C;QAC1C,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACrD,IAAI,CAAC,SACL,MAAM,CAAC,oDACP,EAAE,CAAC,MAAM,SACT,EAAE,CAAC,WAAW;QAEjB,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,2BAA2B;YACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC,GAAG;gBAAE,QAAQ;YAAI;QACrF;QAEA,IAAI,CAAC,gBAAgB,aAAa,MAAM,KAAK,QAAQ,MAAM,EAAE;YAC3D,QAAQ,IAAI,CAAC,4BAA4B;gBAAE,WAAW,QAAQ,MAAM;gBAAE,OAAO,cAAc;gBAAQ;YAAa;YAChH,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,QAAQ,GAAG,CAAC,6BAA6B,aAAa,GAAG,CAAC,CAAA,IAAK,CAAC;gBAAE,IAAI,EAAE,EAAE;gBAAE,QAAQ,EAAE,MAAM;gBAAE,gBAAgB,EAAE,cAAc;YAAC,CAAC;QAEhI,0EAA0E;QAC1E,MAAM,MAAM,KAAK,GAAG;QAEpB,MAAM,qBAA+B,EAAE;QAEvC,MAAM,mBAAmB,AAAC,aAA+B,MAAM,CAAC,CAAC;YAC/D,8EAA8E;YAC9E,MAAM,KAAK,CAAC,AAAC,EAAE,MAAM,IAAe,WAAW,EAAE,QAAQ,GAAG,WAAW;YAEvE,IAAI,OAAO,aAAa,OAAO;YAE/B,IAAI,OAAO,YAAY;gBACrB,qEAAqE;gBACrE,MAAM,QAAQ,EAAE,cAAc,GAAG,IAAI,KAAK,EAAE,cAAc,EAAE,OAAO,KAAK;gBACxE,IAAI,SAAS,QAAQ,KAAK;oBACxB,OAAO,KAAK,iBAAiB;;gBAC/B;gBAEA,mEAAmE;gBACnE,mBAAmB,IAAI,CAAC,EAAE,EAAE;gBAC5B,OAAO;YACT;YAEA,kDAAkD;YAClD,OAAO;QACT;QAEA,6DAA6D;QAC7D,IAAI,mBAAmB,MAAM,GAAG,GAAG;YACjC,QAAQ,GAAG,CAAC,0CAA0C;YACtD,IAAI;gBACF,MAAM,SAAS,IAAI,CAAC,SAAS,MAAM,CAAC;oBAAE,QAAQ;oBAAa,gBAAgB;gBAAK,GAAG,EAAE,CAAC,MAAM;YAC9F,EAAE,OAAO,GAAG;gBACV,QAAQ,IAAI,CAAC,+CAA+C;oBAAE;oBAAoB,OAAO;gBAAE;YAC7F;QACF;QACA,QAAQ,GAAG,CAAC,iCAAiC;YAAE,oBAAoB,iBAAiB,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE;YAAG,OAAO,iBAAiB,MAAM;QAAC;QACnI,IAAI,iBAAiB,MAAM,GAAG,GAAG;YAC/B,MAAM,WAAW,iBAAiB,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,GAAG,CAAC,OAAO,EAAE,EAAE,MAAM,EAAE,EAAE,IAAI,CAAC;YACpF,QAAQ,GAAG,CAAC,4CAA4C;gBAAE;gBAAU,KAAK,iBAAiB,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE;YAAE;YACzG,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO,CAAC,sCAAsC,EAAE,UAAU;gBAC1D,oBAAoB,iBAAiB,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;YACtD,GACA;gBAAE,QAAQ;YAAI;QAElB;QAGA,qFAAqF;QACrF,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACtD,IAAI,CAAC,SACL,MAAM,CAAC;YAAE,QAAQ;YAAY,gBAAgB;QAAc,GAC3D,EAAE,CAAC,MAAM,SACT,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,UAAU,aACb,MAAM,CAAC;QAEV,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,QAAQ,KAAK,CAAC,8BAA8B;gBAAE,MAAM,YAAY,IAAI;gBAAE,SAAS,YAAY,OAAO;gBAAE,SAAS,AAAC,YAAoB,OAAO;YAAC;YAC1I,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAA+B,SAAS,YAAY,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACjH;QAEA,mCAAmC;QACnC,IAAI,CAAC,gBAAgB,aAAa,MAAM,KAAK,QAAQ,MAAM,EAAE;YAC3D,4DAA4D;YAC5D,MAAM,cAAc,AAAC,cAAmC,IAAI,CAAC,IAAM,EAAE,EAAE,KAAK,EAAE;YAC9E,QAAQ,GAAG,CAAC,gCAAgC;gBAAE,WAAW,QAAQ,MAAM;gBAAE,SAAS,cAAc;gBAAQ,YAAY;YAAY;YAChI,IAAI,YAAY,MAAM,GAAG,GAAG;gBAC1B,MAAM,SAAS,IAAI,CAAC,SAAS,MAAM,CAAC;oBAAE,QAAQ;oBAAa,gBAAgB;gBAAK,GAAG,EAAE,CAAC,MAAM;YAC9F;YAEA,MAAM,cAAc,QAAQ,MAAM,GAAG,CAAC,cAAc,UAAU,CAAC;YAC/D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,GAAG,YAAY,yCAAyC,CAAC;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC/G;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACJ,SAAS,AAAC,aAAkC,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;QACzD;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;IACzE;AACF"}}]
}